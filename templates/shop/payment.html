{% extends "base.html" %}
{% load static %}

{% block content %}
   

    <div class="container-fluid pt-5">
        <div class="row px-xl-5">           
            <div class="col-lg-6 table-responsive mb-5">
                <div class="card">
                    <h5 class="card-header text-center">Review Your Order and Make Payment</h5>
                    <div class="card-body">
                        <h5 class="card-title">Billing Address</h5>
                        <p class="card-text">{{user.full_name}}</p>
                        <p class="card-text">{{order.shipping_address}}</p>
                        <p class="card-text">{{user.userprofile.phone}}</p>
                       
                        {% if order.order_note %}
                            <b>Order Note : </b> {{order.order_note}}
                        {% endif %}
                    </div>
                    
                    <div class="card-body">
                      <h5 class="card-title">Review Product</h5>
                      <p class="card-text">
                        <table class="table table-bordered text-center mb-0">
                            <thead class="bg-secondary text-dark">
                                <tr>
                                    <th>Products</th>
                                    <th>Quantity</th>
                                    <th>Price</th>
                                </tr>
                            </thead>
                            <tbody class="align-middle">
                                {% for cart_item in cart_items %}
                                <tr>
                                    <td style="position: relative;">
                                        <div style="text-align: center;">
                                            <img src="{{ cart_item.product_attribute.image.url }}" alt="{{ cart_item.product_attribute.product }}" style="width: 50px;">
                                            <a href="{{ cart_item.product_attribute.product.get_url }}"> {{ cart_item.product_attribute.product }} </a>
                                        </div>
                                        <div class="ml-5 mb-2" >                               
                                            <p class="text-muted small mb-2">Size: {{cart_item.product_attribute.size | capfirst}}</p>                   
                                            <p class="text-muted small mb-2">Color: {{cart_item.product_attribute.color | capfirst}}</p>        
                                        </div>
                                    </td>                            
                                    <td class="align-middle">
                                        <div class="input-group quantity mx-auto" style="width: 100px;">
                                            <input type="text" class="form-control form-control-sm bg-secondary text-center" value="{{ cart_item.quantity }}">                  
                                        </div>
                                    </td>
                                    <td class="align-middle">Rs {{cart_item.sub_total}}</td>
                                </tr> 
                                {% endfor %}                
                            </tbody>
                        </table>
                      </p>
                    </div>
                </div>             
            </div>
            <div class="col-lg-5">
                <div class="card border-secondary mb-5">
                    <div class="card-body">
                        <div class="d-flex justify-content-between mb-3 pt-1">
                            <h6 class="font-weight-medium">Subtotal</h6>
                            <h6 class="font-weight-medium">Rs {{total}}</h6>
                        </div>
                        <div class="d-flex justify-content-between">
                            <h6 class="font-weight-medium">Tax</h6>
                            <h6 class="font-weight-medium">+ Rs {{tax}}</h6>
                        </div>
                        {% if discount %}
                        <div class="d-flex justify-content-between">
                            <h6 class="font-weight-medium">Discount</h6>
                            <h6 class="font-weight-medium">- Rs {{ discount }}</h6>
                        </div>
                        {% endif %}
                    </div>
                    <div class="card-footer border-secondary bg-transparent">
                        <div class="d-flex justify-content-between mt-2">
                            <h5 class="font-weight-bold">Total</h5>
                            <h5 class="font-weight-bold">Rs {{grand_total}}</h5>
                        </div>
                        <p><input type="hidden" name="order_id" class="form-control" value="{{order.id}}"></p>
                        
                        <a href="{% url "cash_on_delivery" order.order_number %}" class="btn btn-block btn-primary my-3 py-2">Cash On Delivery</a>
                        <a href="{% url "payment_with_wallet" order.order_number %}" class="btn btn-block btn-primary my-3 py-2">Pay with Wallet</a>
                        <a id="rzp-button1" class="btn btn-block btn-primary my-3 py-2">Pay with Razorpay</a>
                        {% include "alerts.html" %}
                    </div>
                </div>
            </div>
        </div>
    </div>

<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
    var options = {
        "key": "rzp_test_GuP6rseUoudWsT",
        "amount": {{ grand_total }} * 100,
        "currency": "INR",
        "name": "Estilo",
        "description": "Purchase",
        "image": "https://example.com/your_logo",
        "order_id": "{{ payment.id }}",
        "handler": function (response) {
            console.log("Payment response:", response);
            alert("Payment successful!");
            var orderNumber = "{{ order.order_number }}";
            console.log("order number response:", orderNumber);
            window.location.href = '/orders/confirm_razorpay_payment/' + orderNumber + '/';
        },
        "prefill": {
            "email": "{{ user.email }}",
            "contact": "{{ user.phone }}"
        },
        "notes": {
            "address": "{{ user.address }}"
        },
        "theme": {
            "color": "#3399cc"
        }
    };

    var rzp1 = new Razorpay(options);

    rzp1.on('payment.error', function (error) {
        console.log("Payment error:", error);
        alert("Payment failed! Please try again.");
        // Handle payment failure directly here
        var orderNumber = "{{ order.order_number }}"; // Assuming this value is available
        console.log("order number response:", orderNumber);
        window.location.href = '/orders/failed_payment/' + orderNumber + '/';
    });

    document.getElementById('rzp-button1').addEventListener('click', function (e) {
        console.log("Button clicked, opening Razorpay checkout...");
        rzp1.open();
        e.preventDefault();
    });
</script>

    {% endblock content %}