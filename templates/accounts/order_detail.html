{% extends "base.html" %}
{% load static %}

{% block content %}

    <!-- Order Details Start -->
    <div class="container pt-5">

        <div class="row px-xl-5">

            <div class="col-lg-12">
                <div class="card mb-5">
                    <h5 class="card-header text-center">Order Details</h5>
                    {% if order.payment.status != 'Failed' and not order.status == "Cancelled" and not order.status == "Returned" %}
                    <a href="{% url 'order_invoice' order.id %}" class="btn btn-primary">View Invoice</a>
                    {% endif %}
                    <div class="card-body">
                        <h5 class="card-title">Order Number: {{ order.order_number }}</h5>
                        <h5 class="card-title">Billing Address</h5>
                        <p class="card-text">{{ user.full_name }}</p>
                        <p class = "card-text">{{order.shipping_address}}</p>
                        <p class="card-text">{{ user.email }}</p>
                        <p class="card-text">{{ user.userprofile.phone }}</p>
                        {% if order.order_note %}
                            <b>Order Note:</b> {{ order.order_note }}
                        {% endif %}
                    </div>
                    <div class="card-footer bg-transparent">
                        <h5 class="card-title">Payment Status</h5>
                        {% if order.status == 'Cancelled' %}
                            <p class="card-text text-danger">Order Cancelled</p>
                        {% elif order.status == 'Returned' %}
                            <p class="card-text text-danger">Order Returned</p>

                        {% else %}
                            {% if order.payment.status == 'Paid' %}
                            <p class="card-text text-success">{{order.payment.status}}</p>
                            {% else %}
                            <p class="card-text text-danger">{{order.payment.status}}</p>
                            {% endif %}
                        {% endif %}
                        {% if order.status == 'Cancelled' %}
                        <h5 class="card-title">Order Cancellation Reason</h5>
                        <p class="card-text ">{{order.cancellation_reason}}</p>

                        {% endif %}
                        {% if order.status == 'Returned' %}
                        <h5 class="card-title">Order Return Reason</h5>
                        <p class="card-text ">{{order.return_reason}}</p>

                        {% endif %}
                    </div>
                </div>
            </div>
            <div class="col-lg-12">
                <div class="card mb-5">
                    <h5 class="card-header text-center">Order Summary</h5>
                    <div class="card-body">
                        <h5 class="card-title">Payment Method</h5>
                        <p class="card-text">{{payment.payment_method}}</p>
                        <h5 class="card-title">Review Product</h5>
                        <p class="card-text">
                            <table class="table table-bordered text-center mb-0">
                                <thead class="bg-secondary text-dark">
                                    <tr>
                                        <th>Products</th>
                                        <th>Product Price</th>
                                        <th>Quantity</th>
                                        <th>Amount</th>
                                    </tr>
                                </thead>
                                <tbody >
                                    {% for item in order_detail %}
                                    <tr>
                                        <td>
                                            <img src="{{ item.product_attribute.image.url }}" alt="{{ item.product_attribute.product }}" style="width: 50px;">
                                            {{ item.product }}
                                            <div class="ml-5 mb-2" >                               
                                                <p class="text-muted small mb-2">Size: {{item.product_attribute.size | capfirst}}, Color: {{item.product_attribute.color | capfirst}}</p>                         
                                            </div>
                                        </td>
                                        <td>Rs {{ item.product_price }}</td>
                                        <td>{{ item.quantity }}</td>
                                        <td>Rs {{ item.total }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </p>
                    </div>
                    <div class="card-footer border-secondary bg-transparent">
                        <div class="d-flex justify-content-between mb-3 pt-1">
                            <h6 class="font-weight-medium">Subtotal</h6>
                            <h6 class="font-weight-medium">Rs {{ subtotal }}</h6>
                        </div>
                        <div class="d-flex justify-content-between">
                            <h6 class="font-weight-medium">Tax</h6>
                            <h6 class="font-weight-medium">Rs {{ order.tax }}</h6>
                        </div>
                        {% if coupon_discount %}
                            <div class="d-flex justify-content-between">
                                <h6 class="font-weight-medium">Discount</h6>
                                <h6 class="font-weight-medium">- Rs {{ coupon_discount }}</h6>
                            </div>
                        {% endif %}
                        <div class="d-flex justify-content-between mt-2">
                            <h5 class="font-weight-bold">Total</h5>
                            <h5 class="font-weight-bold">Rs {{ grand_total }}</h5>
                        </div>
                        <a href="{% url 'home' %}" class="btn btn-block btn-primary my-3 py-3">Back to Home</a>
                        {% if order.payment.status == 'Failed' and not order.status == "Cancelled" %}
                        <a id="rzp-button1" class="btn btn-block btn-primary my-3 py-2">Continue Payment</a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Order Details End -->
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script>
    var options = {
        "key": "rzp_test_GuP6rseUoudWsT",
        "amount": {{ grand_total }} * 100,
        "currency": "INR",
        "name": "Estilo",
        "description": "Purchase",
        "image": "https://example.com/your_logo",
        "order_id": "{{ payment.payment_id }}",
        "handler": function (response) {
            console.log("Payment response:", response);
            alert("Payment successful!");
            var orderNumber = "{{ order.order_number }}";
            console.log("order number response:", orderNumber);
            window.location.href = '/orders/continue_payment/' + orderNumber + '/';
        },
        "prefill": {
            "email": "{{ user.email }}",
            "contact": "{{ user.phone }}"
        },
        "notes": {
            "address": "{{ user.address }}"
        },
        "theme": {
            "color": "#3399cc"
        }
    };

    var rzp1 = new Razorpay(options);

    rzp1.on('payment.error', function (error) {
        console.log("Payment error:", error);
        alert("Payment failed! Please try again.");
        // Handle payment failure directly here
        var orderNumber = "{{ order.order_number }}"; // Assuming this value is available
        console.log("order number response:", orderNumber);
        window.location.href = '/orders/failed_payment/' + orderNumber + '/';
    });

    document.getElementById('rzp-button1').addEventListener('click', function (e) {
        console.log("Button clicked, opening Razorpay checkout...");
        rzp1.open();
        e.preventDefault();
    });
</script>

{% endblock content %}
